{% extends './Appt_base.html' %}
{% load static %}

{% block content %}
    <div class="content" id="content" style="display:none;text-align:center;">
      <br>
        <h3><b>来訪ありがとうございます!</b></h3>
        <p>家先のQRコードを読み込んでください</p>
    <br>
    <h3>QRCode Reader</h3>
    <section id="contents" style="text-align:center;">
      <!-- カメラ映像 -->
      <video id="camera" style="justify-content: center;" height="300px" playsinline></video>
      <!-- 処理用 -->
      <canvas id="picture" height="300px" style="justify-content: center;display:none;" ></canvas>
      <!-- 読み取り結果 -->
      <div id="result"  style="justify-content: center;" height="300px" playsinline>
        <small style="color:gray; "></small>
      </div>
    </section>
    <!--<div id="scan">
      <a href="javascript:onbuttonStart()" class="btn_01">
        読み取り開始</a><br>
    </div>-->
    </div>


    <script src="{% static 'js/jsQR.js' %}"></script>
    <script>
      window.onload = function(){
        if({{ true_number.update_url_text }}!={{ number }}){
          window.alert('URLが違います。\n正しいURLでアクセスし直してください。');
        }else{
          var element = document.getElementById('content')
          element.style.display = 'block';
          startGeolocation();
        }
      }

      const video  = $("#camera");
      const canvas = $("#picture");
      const ctx = canvas.getContext("2d");
      const result = $("#result");
      //function onbuttonStart(){
      //  startGeolocation();
      //};
      function initCamera(){
        // カメラ設定
        const constraints = {
          audio: false,
          video: {
            width: canvas.width,
            height: canvas.height,
            //facingMode: "user"   // フロントカメラを利用する
            facingMode: "environment"   // フロントカメラを利用する
          }
        };
        /**
         * カメラを<video>と同期
         */
         navigator.mediaDevices.getUserMedia(constraints)
         .then( (stream) => {
           video.srcObject = stream;
           video.onloadedmetadata = (e) => {
             video.play();

            // QRコードのチェック開始
            checkPicture();
          };
        })
        .catch( (err) => {
          console.log(err.name + ": " + err.message);
        });
        result.style.display = 'none';
      }
      /**
       * QRコードの読み取り
       */
      function checkPicture(){
        // カメラの映像をCanvasに複写
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // QRコードの読み取り
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);

        //----------------------
        // 存在する場合
        //----------------------
        if( code ){
          // 結果を表示
          setQRResult("#result", code.data);  // 文字列
          drawLine(ctx, code.location);       // 見つかった箇所に線を引く

          // video と canvas を入れ替え
          canvas.style.display = 'block';
          video.style.display = 'none';
          video.pause();
        }
        //----------------------
        // 存在しない場合
        //----------------------
        else{
          // 0.3秒後にもう一度チェックする
          setTimeout( () => {
            checkPicture();
          }, 300);
        }
      }

      /**
       * 発見されたQRコードに線を引く
       *
       * @param {Object} ctx
       * @param {Object} pos
       * @param {Object} options
       * @return {void}
       */
      function drawLine(ctx, pos, options={color:"blue", size:5}){
        // 線のスタイル設定
        ctx.strokeStyle = options.color;
        ctx.lineWidth   = options.size;

        // 線を描く
        ctx.beginPath();
        ctx.moveTo(pos.topLeftCorner.x, pos.topLeftCorner.y);         // 左上からスタート
        ctx.lineTo(pos.topRightCorner.x, pos.topRightCorner.y);       // 右上
        ctx.lineTo(pos.bottomRightCorner.x, pos.bottomRightCorner.y); // 右下
        ctx.lineTo(pos.bottomLeftCorner.x, pos.bottomLeftCorner.y);   // 左下
        ctx.lineTo(pos.topLeftCorner.x, pos.topLeftCorner.y);         // 左上に戻る
        ctx.stroke();
      }

      /**
       * QRコードの読み取り結果を表示する
       *
       * @param {String} id
       * @param {String} data
       * @return {void}
       */
      function setQRResult(id, data){
        $(id).innerHTML = escapeHTML(data);
        fetch('/save_qrcode/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}', // DjangoのCSRFトークンを追加
          },
          body: JSON.stringify({ 'qrData': data}),
        })
        .then(response => {
          if (!response.ok) {
              throw new Error('サーバーへの送信に失敗しました');
          }
          return response.json();
        })
        .then(data => {
          //リダイレクトフラグをチェック
          if (data.redirect){
            //window.location.href = 'Appt_end';
            window.location.href = "{% url 'Appt_end' %}";
          }else{
            $(id).style.display = 'inline';
            $(id).innerHTML = data.message;
            console.log(data.message); // サーバーからの応答をコンソールに表示
            // 3秒後にもう一度チェックする
            setTimeout( () => {
              initCamera();
            }, 3000);
          }
        })
        .catch(error => console.error(error.message));
      }

      /**
       * jQuery style wrapper
       *
       * @param {string} selector
       * @return {Object}
       */
      function $(selector){
        return( document.querySelector(selector) );
      }

      /**
       * HTML表示用に文字列をエスケープする
       *
       * @param {string} str
       * @return {string}
       */
      function escapeHTML(str){
        let result = "";
        result = str.replace("&", "&amp;");
        result = str.replace("'", "&#x27;");
        result = str.replace("`", "&#x60;");
        result = str.replace('"', "&quot;");
        result = str.replace("<", "&lt;");
        result = str.replace(">", "&gt;");
        result = str.replace(/\n/, "<br>");

        return(result);
      }

      /*
        位置情報の取得

        @param {String} id
        @param {String} data
        @return {void}
        */
      function setgeolocation(id, latitude, longitude){
        //$(id).innerHTML = longitude;
        fetch('/save_geolocation/', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}', // DjangoのCSRFトークンを追加
          },
          body: JSON.stringify({ 'latitude': latitude,'longitude': longitude}),
        })
        .then(response => {
          if (!response.ok) {
              throw new Error('サーバーへの送信に失敗しました');
          }
          return response.json();
        })
        .then(data => {
          //リダイレクトフラグをチェック OKだったらQRコード読み取り開始
          if (data.redirect){
            initCamera();
          }else{
            $(id).style.display = 'inline';
            $(id).innerHTML = data.message;
            console.log(data.message); // サーバーからの応答をコンソールに表示
          }
        })
        .catch(error => console.error(error.message));
      }

      // 位置情報取得処理に渡すオプション
      var options = {
        // 高精度な位置情報を取得するか(デフォルトはfalse)
        enableHightAccuracy: true,
        // 取得した位置情報をキャッシュする時間(ミリ秒。デフォルトは0)
        maximumAge: 0,
        // 何秒でタイムアウトとするか(ミリ秒。タイムアウトするとerrorCallback()がコールされる)
        timeout: 120000
      }

      // 位置情報取得処理が成功した時にコールされる関数
      // 引数として、coords(coordinates。緯度・経度など)とtimestamp(タイムスタンプ)の2つを持ったpositionが渡される
      function successCallback(position){
        // メッセージを表示
        //document.getElementById("result").innerHTML += "位置情報取得成功<br />";
        //document.getElementById("scan").style.display ="none";
        setgeolocation("#result", position.coords.latitude,position.coords.longitude);
      }

      // 位置情報取得処理が失敗した時にコールされる関数
      // 引数として、code(コード)とmessage(メッセージ)の2つを持ったpositionErrorが渡される
      function errorCallback(positionError){
        var element = document.getElementById('content')
        element.style.display = 'none';
          // メッセージを表示
          //document.getElementById("result").innerHTML += "位置情報の取得に失敗しました<br />";
          var error_message = "位置情報の取得に失敗しました\n\n";

          // 引数positionErrorの中身2つを取り出す
          // コード(1～3のいずれかの値)
          var code = positionError.code;
          // メッセージ(開発者向けデバッグ用メッセージ)
          //var message = positionError.message;

          // コードに応じたメッセージを表示
          switch (code) {
              case positionError.PERMISSION_DENIED: // codeが1
                  //document.getElementById("result").innerHTML += "GeolocationAPIのアクセス許可がありません<br />";
                  //document.getElementById("result").innerHTML += "スマートフォンの設定から位置情報が許可になっているか確認してください<br />";
                  //error_message += "GeolocationAPIのアクセス許可がありません\n";
                  error_message += "スマートフォンの設定から位置情報が許可になっているか確認してください\n";
                  break;
              case positionError.POSITION_UNAVAILABLE: // codeが2
                  //document.getElementById("result").innerHTML += "現在の位置情報を特定できませんでした<br />";
                  //document.getElementById("result").innerHTML += "再読み込みしてください<br />";
                  error_message += "現在の位置情報を特定できませんでした\n";
                  error_message += "再読み込みしてください\n";
                  break;
              case positionError.TIMEOUT: // codeが3
                  //document.getElementById("result").innerHTML += "指定されたタイムアウト時間内に現在の位置情報を特定できませんでした<br />";
                  //document.getElementById("result").innerHTML += "再読み込みしてください<br />";
                  error_message += "指定されたタイムアウト時間内に現在の位置情報を特定できませんでした\n";
                  error_message += "再読み込みしてください\n";
                  break;
          }

          //エラーメッセージ表示アラーム
          alert(error_message);

          // 開発者向けデバッグ用メッセージを表示
          //document.getElementById("result").innerHTML += message + "<br /><br />";
      }

      // 位置情報取得開始
      function startGeolocation(){
          // メッセージ表示領域をクリア
          document.getElementById("result").innerHTML = "";

          // ブラウザがGeolocation APIに対応しているかをチェック
          if (navigator.geolocation) {
              // 対応している → 位置情報取得開始
              // 位置情報取得成功時にsuccessCallback()、そして取得失敗時にerrorCallback()がコールされる
              // optionsはgetCurrentPosition()に渡す設定値
              navigator.geolocation.getCurrentPosition(successCallback, errorCallback , options);

              // メッセージを表示。↑は非同期処理なので、直ぐにメッセージが表示される
              //document.getElementById("result").innerHTML += "位置情報取得中<br />";

          } else {
              // 対応していない → alertを表示するのみ
              alert("Geolocation not supported in this browser");
          }
      }
    </script>
{% endblock %}
